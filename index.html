<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bluetooth Printer Finder</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; padding: 20px; background: #eceff1; color: #333; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 400px; margin: 0 auto; }
        button { width: 100%; padding: 12px; font-size: 16px; cursor: pointer; border-radius: 8px; border: none; margin: 10px 0; transition: 0.3s; }
        .btn-search { background-color: #6200ee; color: white; }
        .btn-print { background-color: #03dac6; color: black; }
        .btn-search:disabled { background-color: #ccc; }
        #info { text-align: left; background: #f9f9f9; padding: 10px; border-radius: 5px; font-size: 13px; margin-top: 15px; display: none; }
        .status-dot { height: 10px; width: 10px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .connected { background-color: #4caf50; }
    </style>
</head>
<body>

<div class="card">
    <h2>‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå</h2>
    <div id="connection-status">
        <span class="status-dot" id="dot"></span>
        <span id="status-text">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span>
    </div>

    <button class="btn-search" onclick="scanAndConnect()">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå Bluetooth</button>
    
    <div id="info">
        <strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠:</strong><br>
        <span id="dev-name"></span><br>
        <span id="dev-id"></span>
    </div>

    <button class="btn-print" id="btnPrint" onclick="printReceipt()" disabled>üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button>
</div>

<script>
    let printerCharacteristic;
    let connectedDevice;

    async function scanAndConnect() {
        try {
            // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
            // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: acceptAllDevices: true ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö services ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏ö‡∏≤‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå
            const device = await navigator.bluetooth.requestDevice({
                filters: [
                    { services: ['000018f0-0000-1000-8000-00805f9b34fb'] }, // ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô Printer
                    { namePrefix: 'TP' }, // ‡πÄ‡∏ä‡πà‡∏ô TP2, TP3
                    { namePrefix: 'MPT' },
                    { namePrefix: 'Printer' }
                ],
                optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb']
            });

            document.getElementById('status-text').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...";
            
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
            const characteristics = await service.getCharacteristics();
            
            // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            printerCharacteristic = characteristics.find(c => c.properties.write || c.properties.writeWithoutResponse);

            if (printerCharacteristic) {
                connectedDevice = device;
                updateUI(true);
            }
        } catch (error) {
            console.error("Connect Error:", error);
            alert("‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: " + error.message);
        }
    }

    function updateUI(isConnected) {
        if (isConnected) {
            document.getElementById('status-text').innerText = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß";
            document.getElementById('dot').classList.add('connected');
            document.getElementById('info').style.display = 'block';
            document.getElementById('dev-name').innerText = "‡∏ä‡∏∑‡πà‡∏≠: " + connectedDevice.name;
            document.getElementById('dev-id').innerText = "ID: " + connectedDevice.id;
            document.getElementById('btnPrint').disabled = false;
        }
    }

    async function printReceipt() {
        if (!printerCharacteristic) return;

        const encoder = new TextEncoder();
        // ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á ESC/POS
        const data = [
            '\x1B\x40',          // Reset
            '\x1B\x61\x01',      // Center
            '--- TEST PRINT ---\n',
            'Device: ' + connectedDevice.name + '\n',
            '--------------------------------\n',
            '\x1B\x61\x00',      // Left
            'Hello World!\n',
            'Bluetooth Printing Works!\n',
            '--------------------------------\n',
            '\n\n\n'             // Feed paper
        ];

        for (const line of data) {
            await printerCharacteristic.writeValue(encoder.encode(line));
        }
    }
</script>

</body>
</html>
