<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Bluetooth Printer (58mm)</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f4f4f9; }
        button { padding: 15px 25px; font-size: 16px; cursor: pointer; border-radius: 8px; border: none; margin: 5px; }
        .connect { background-color: #4CAF50; color: white; }
        .print { background-color: #2196F3; color: white; }
        #status { margin-top: 20px; color: #666; }
    </style>
</head>
<body>

    <h2>เครื่องพิมพ์ใบเสร็จ 58mm</h2>
    <p>เชื่อมต่อผ่าน Web Bluetooth API</p>

    <button class="connect" onclick="connectBluetooth()">1. เชื่อมต่อเครื่องพิมพ์</button>
    <br>
    <button class="print" onclick="printReceipt()">2. พิมพ์ใบเสร็จ</button>

    <div id="status">สถานะ: รอการเชื่อมต่อ...</div>

    <script>
        let printerCharacteristic;

        // ฟังก์ชันเชื่อมต่อ Bluetooth
        async function connectBluetooth() {
            try {
                document.getElementById('status').innerText = "กำลังค้นหาอุปกรณ์...";
                
                // ค้นหาอุปกรณ์ Bluetooth ที่ให้บริการ Generic Attribute
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: ['000018f0-0000-1000-8000-00805f9b34fb'] }], // Service มาตรฐานของ Printer ส่วนใหญ่
                    optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb']
                });

                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
                
                // ดึง Characteristic สำหรับการเขียนข้อมูล (Write)
                const characteristics = await service.getCharacteristics();
                printerCharacteristic = characteristics.find(c => c.properties.write || c.properties.writeWithoutResponse);

                document.getElementById('status').innerText = "เชื่อมต่อสำเร็จ: " + device.name;
            } catch (error) {
                console.error(error);
                document.getElementById('status').innerText = "ข้อผิดพลาด: " + error;
            }
        }

        // ฟังก์ชันส่งข้อมูลไปยังเครื่องพิมพ์
        async function printReceipt() {
            if (!printerCharacteristic) {
                alert("กรุณาเชื่อมต่อเครื่องพิมพ์ก่อน!");
                return;
            }

            // คำสั่ง ESC/POS เบื้องต้น
            const encoder = new TextEncoder(); // ใช้ UTF-8 (ภาษาไทยอาจต้องใช้การแปลงรหัสเฉพาะตัวเครื่อง)
            
            // เตรียมข้อมูลใบเสร็จ (รองรับประมาณ 32 ตัวอักษรสำหรับ 58mm)
            const commands = [
                '\x1B\x40',          // Initialize printer
                '\x1B\x61\x01',      // Align center
                'MY SHOP\n',         // ชื่อร้าน
                '--------------------------------\n',
                '\x1B\x61\x00',      // Align left
                'Item           Qty    Price\n',
                'Coffee          1     60.00\n',
                'Cake            1     85.00\n',
                '--------------------------------\n',
                '\x1B\x61\x02',      // Align right
                'TOTAL: 145.00 THB\n\n',
                '\x1B\x61\x01',      // Align center
                'THANK YOU\n',
                '\n\n\n'             // เว้นบรรทัดสำหรับตัดกระดาษ
            ];

            for (const cmd of commands) {
                await printerCharacteristic.writeValue(encoder.encode(cmd));
            }
            
            document.getElementById('status').innerText = "ส่งข้อมูลการพิมพ์สำเร็จ!";
        }
    </script>
</body>
</html>
